[
  {
    "id": "d3f9a6ec-0f84-4d3b-b95c-12d6f2476a40",
    "name": "Day8 - Deep Research",
    "active": true,
    "nodes": [
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "deep-research",
          "responseMode": "lastNode"
        },
        "id": "webhook_deep_research",
        "webhookId": "deep-research",
        "name": "Webhook Deep Research",
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          260,
          320
        ]
      },
      {
        "parameters": {
          "mode": "runOnceForEachItem",
          "jsCode": "const body = $json.body || $json;\nconst action = String(body.action || '').trim().toLowerCase();\nconst now = Math.floor(Date.now() / 1000);\nconst runIdRaw = String(body.run_id || '').trim();\nconst runId = runIdRaw || `rr-${now}-missing`;\n\nconst sanitize = (value, maxLen = 4000) => String(value || '').replace(/\\s+/g, ' ').trim().slice(0, maxLen);\nconst toInt = (value, fallback) => { const parsed = Number(value); return Number.isFinite(parsed) ? Math.floor(parsed) : fallback; };\nconst slugify = (value) => String(value || '').toLowerCase().replace(/[^a-z0-9-]+/g, '-').replace(/^-+|-+$/g, '').slice(0, 80) || 'research-report';\n\nconst nextcloudBase = sanitize(body.nextcloud_base_url || 'http://nextcloud', 600).replace(/\\/+$/, '');\nconst nextcloudUser = sanitize(body.nextcloud_user || '', 200);\nconst nextcloudPassword = String(body.nextcloud_password || '');\nconst nextcloudFolder = slugify(body.nextcloud_folder || 'research-reports');\n\nconst store = $getWorkflowStaticData('global');\nif (!store.__deepResearchJobs || typeof store.__deepResearchJobs !== 'object') store.__deepResearchJobs = {};\nconst jobs = store.__deepResearchJobs;\n\nconst summarize = (job) => ({ run_id: runId, status: String(job.status || 'queued'), report_url: String(job.report_url || ''), report_title: String(job.report_title || ''), link_expires_at: toInt(job.link_expires_at, now + 86400), error: String(job.error || '') });\n\nif (action === 'status' || action === 'report') {\n  const existing = jobs[runId];\n  if (existing && typeof existing === 'object') {\n    existing.updated_at = now;\n    jobs[runId] = existing;\n    return summarize(existing);\n  }\n\n  const hintedUrl = sanitize(body.report_url_hint || '', 2000);\n  if (hintedUrl) {\n    return { run_id: runId, status: 'ready', report_url: hintedUrl, report_title: sanitize(body.report_title_hint || 'Deep Research Report', 180), link_expires_at: toInt(body.link_expires_at_hint, now + 86400), error: '' };\n  }\n\n  return { run_id: runId, status: 'failed', error: 'run_not_found', report_url: '', report_title: '', link_expires_at: now + 300 };\n}\n\nif (action !== 'start') return { run_id: runId, status: 'failed', error: 'unsupported_action', report_url: '', report_title: '', link_expires_at: now + 300 };\n\nconst query = sanitize(body.query || body.prompt || '', 2000);\nif (!query) return { run_id: runId, status: 'failed', error: 'query_required', report_url: '', report_title: '', link_expires_at: now + 300 };\nif (!nextcloudUser || !nextcloudPassword) return { run_id: runId, status: 'failed', error: 'nextcloud_credentials_missing', report_url: '', report_title: '', link_expires_at: now + 300 };\n\nconst ttlInput = toInt((body.delivery && body.delivery.link_ttl_seconds) || body.link_ttl_seconds, 86400);\nconst ttlSeconds = Math.max(60, ttlInput);\nconst linkExpiresAt = now + ttlSeconds;\nconst reportTitle = `Deep Research Report: ${query.slice(0, 120)}`;\nconst titleSeed = slugify((query || runId).slice(0, 64));\nconst fileName = `${runId}-${titleSeed}.md`;\nconst webdavFolder = `/${nextcloudFolder}`;\nconst webdavFilePath = `${webdavFolder}/${fileName}`;\n\nconst authHeader = `Basic ${Buffer.from(`${nextcloudUser}:${nextcloudPassword}`).toString('base64')}`;\nconst encodePath = (value) => String(value || '').split('/').filter(Boolean).map((part) => encodeURIComponent(part)).join('/');\nconst fileUrl = `${nextcloudBase}/remote.php/dav/files/${encodeURIComponent(nextcloudUser)}/${encodePath(webdavFilePath)}`;\nconst shareApiUrl = `${nextcloudBase}/ocs/v2.php/apps/files_sharing/api/v1/shares?format=json`;\n\nconst requestedBy = sanitize(body.full_name || body.telegram_username || body.user_id || 'telegram-user', 120);\nconst generatedAt = new Date(now * 1000).toISOString();\nconst reportContent = '# Deep Research Report\\n\\n' + `- run_id: ${runId}\\n` + `- generated_at: ${generatedAt}\\n` + `- requested_by: ${requestedBy}\\n\\n` + '## Query\\n' + query + '\\n\\n## Summary\\nAutomated report scaffold generated by Day8 deep-research workflow. Replace this section with full synthesis pipeline output.\\n';\n\nconst request = async (opts) => this.helpers.httpRequest({ ...opts, timeout: 30000 });\n\ntry {\n  await request({ method: 'PUT', url: fileUrl, headers: { Authorization: authHeader, 'Content-Type': 'text/markdown; charset=utf-8' }, body: reportContent });\n\n  const expireDate = new Date(linkExpiresAt * 1000).toISOString().slice(0, 10);\n  const formBody = `path=${webdavFilePath}&shareType=3&permissions=1&expireDate=${expireDate}`;\n  const shareResp = await request({ method: 'POST', url: shareApiUrl, headers: { Authorization: authHeader, 'OCS-APIRequest': 'true', Accept: 'application/json', 'Content-Type': 'application/x-www-form-urlencoded' }, body: formBody });\n\n  let payload = shareResp;\n  if (typeof payload === 'string') { try { payload = JSON.parse(payload); } catch (_err) { payload = {}; } }\n  const statusCode = Number(payload && payload.ocs && payload.ocs.meta ? payload.ocs.meta.statuscode : 0);\n  if (statusCode && statusCode !== 100 && statusCode !== 200) return { run_id: runId, status: 'failed', error: `nextcloud_share_status_${statusCode}`, report_url: '', report_title: '', link_expires_at: linkExpiresAt };\n\n  const shareUrl = sanitize(payload && payload.ocs && payload.ocs.data ? payload.ocs.data.url : '', 2000);\n  if (!shareUrl) return { run_id: runId, status: 'failed', error: 'nextcloud_share_url_missing', report_url: '', report_title: '', link_expires_at: linkExpiresAt };\n\n  const result = { run_id: runId, status: 'ready', report_url: shareUrl, report_title: reportTitle, link_expires_at: linkExpiresAt, error: '', query, file_path: webdavFilePath, updated_at: now };\n  jobs[runId] = result;\n  return summarize(result);\n} catch (err) {\n  return { run_id: runId, status: 'failed', error: sanitize((err && err.message) || err || 'nextcloud_unknown_error', 300), report_url: '', report_title: '', link_expires_at: linkExpiresAt };\n}"
        },
        "id": "handle_research_contract",
        "name": "Handle Research Contract",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          560,
          320
        ]
      }
    ],
    "connections": {
      "Webhook Deep Research": {
        "main": [
          [
            {
              "node": "Handle Research Contract",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "settings": {},
    "pinData": {},
    "staticData": null,
    "tags": []
  }
]
